# Hướng dẫn giải quyết lỗi 422 khi truy cập trang Admin

## Vấn đề
Khi truy cập trang `/admin`, bạn gặp lỗi 422 hoặc không thể truy cập được. Điều này xảy ra vì:

1. **Nguyên nhân chính**: Tài khoản của bạn chưa được cấp quyền admin
2. **Hệ thống bảo mật**: Chỉ người dùng có role "admin" mới có thể truy cập trang quản trị

## Giải pháp

### Bước 1: Kiểm tra role hiện tại
```bash
# Liệt kê tất cả admin users hiện tại
python scripts/grant_admin_role.py --list
```

### Bước 2: Cấp quyền admin cho tài khoản của bạn
```bash
# Thay your-email@example.com bằng email tài khoản của bạn
python scripts/grant_admin_role.py your-email@example.com
```

### Bước 3: Đăng xuất và đăng nhập lại
- Đăng xuất khỏi hệ thống
- Đăng nhập lại để role mới có hiệu lực
- Truy cập `/admin` để kiểm tra

## Nếu script báo lỗi về bảng user_roles

Bảng `user_roles` có thể chưa tồn tại trong database. Bạn cần tạo bảng này:

### Cách 1: Tạo qua Supabase Dashboard
1. Mở [Supabase Dashboard](https://app.supabase.com)
2. Chọn project của bạn
3. Vào **Table Editor**
4. Tạo bảng mới với tên `user_roles`
5. Thêm các cột:
   - `id`: `int8` (Primary Key, Identity)
   - `user_id`: `uuid` (Foreign Key to auth.users)
   - `role`: `text` (Default: 'student')
   - `created_at`: `timestamptz` (Default: now())

### Cách 2: Chạy SQL trực tiếp
```sql
-- Tạo bảng user_roles
CREATE TABLE user_roles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    role TEXT DEFAULT 'student' CHECK (role IN ('admin', 'student')),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tạo index cho performance
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role ON user_roles(role);

-- Bật RLS (Row Level Security)
ALTER TABLE user_roles ENABLE ROW LEVEL SECURITY;

-- Tạo policy cho admin
CREATE POLICY "Admin can manage all roles" ON user_roles
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM user_roles ur 
            WHERE ur.user_id = auth.uid() 
            AND ur.role = 'admin'
        )
    );
```

## Cách kiểm tra role trong code

Sau khi cấp quyền admin, bạn có thể kiểm tra role trong frontend:

```typescript
// Trong useAuth hook
const { user } = useAuth();
console.log('User role:', user?.role);

// Role sẽ là 'admin' nếu đã cấp quyền thành công
```

## Tính năng mới đã cải thiện

1. **Error handling tốt hơn**: Admin dashboard hiện hiển thị thông báo lỗi rõ ràng khi không có quyền
2. **Role checking**: Admin layout kiểm tra role trước khi cho phép truy cập
3. **Loading states**: Hiển thị loading khi đang kiểm tra quyền truy cập
4. **User-friendly messages**: Thông báo lỗi dễ hiểu và hướng dẫn người dùng

## Debug

Nếu vẫn gặp vấn đề, hãy kiểm tra:

1. **Console logs**: Mở Developer Tools để xem logs
2. **Network tab**: Kiểm tra response từ API
3. **Database**: Xác nhận dữ liệu trong bảng `user_roles`

```bash
# Kiểm tra API health
curl http://localhost:8000/health

# Kiểm tra auth endpoint
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:8000/api/auth/user
```

## Liên hệ

Nếu vẫn gặp vấn đề, vui lòng:
1. Kiểm tra logs trong console
2. Đảm bảo server đang chạy
3. Xác nhận kết nối database Supabase
4. Kiểm tra cấu hình environment variables 